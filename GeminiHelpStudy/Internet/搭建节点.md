## 引入GitHub工具`x-ui`
### 基本配置
```bash
bash <(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)
```
> [!warning] 配置给IOS
> 配置给IOS的时候，位置目标为`www.microsoft.com:443`，SNI为`www.microsoft.com`
> `uTLS`为`Chrome`

### SSH端口修改
- 若是害怕扫描，可以将端口改为冷门端口
- 但是要修改`/etc/ssh/sshd_config`文件中的`Port [端口号]`
- 修改完之后用`sshd -t`检查语法
- 通过之后用`systemctl restart ssh`重启一下 ssh 启用新配置
- 先别关已连接的窗口，开一个新的窗口来测试
> [!warning] 注意
> 若是打开了防火墙，记得把对应端口打开
> `ufw allow [端口号]/tcp` - 加入允许通过的`端口号/协议`
> `ufw reload` - 重新加载防火墙

### 入站配置
- 协议选`vless`+`Reality`+`客户端xtls-rprx-vision`
- `Reality`的伪装建议
	- `www.icloud.com`
	- `www.microsoft.com`
> [!warning] `Reality` 注意事项
> `443`和`80`端口是`Reality`用于表演的端口
> 配置`dect`的时候格式一定是`[域名]:443`才可以让`Reality`去偷别人证书
> 即使是节点进站端口不是 `443` 也要遵循上面的规则
> 防火墙默认是防止入站（Inbound），所以如果节点进站端口不是`443`就不要开`443`端口了，防止被别人识破
- `uTLS`默认就用`chrome`就行了
- 客户端的`Flow`记得选`xtls-rprx-vision` - `Reality`的子协议
- 设置公钥和秘钥
- 把 `Sniffing` 全部都打开就行了
> [!info] 注意
> `Metadata Only`不用开
> `Route Only`不用开

---

## 无法接接

### 防火墙
```bash
ufw allow [端口号]/[协议]
ufw allow 443/tcp
ufw reload
```
> [!warning] SSH
> SSH远程连接要改端口的话，要改配置文件

### DNS问题
```bash
echo -e "nameserver 8.8.8.8\nnameserver 1.1.1.1" > /etc/resolv.conf
```

### 时差问题
- 通过以下命令即可检测
```bash
date
```
- 修复办法：（Ubuntu的方式）
```bash
apt install ntpdate -y && ntpdate pool.ntp.org
```

---

## 质量检测
```bash
bash <(curl -L -s https://raw.githubusercontent.com/lmc999/RegionRestrictionCheck/main/check.sh)
```

---

## 晚高峰稳定性提升
### 开启BBR
- `Linux`默认的`BBRv1`
```bash
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p
```
> [!tip] 不要为速度而改变内核，不用引入别的BBR协议，就用自带就行了

### 修改网卡 MTU
- **服务端改 MTU (Outgoing)**：你把服务器网卡设为 1380，服务器发给你的数据包（下载流量，如看视频）就会自动切成小片。这对**下载速度**提升巨大。
```bash
# 先看网卡名，通常是 eth0 或 enp1s0
ip addr
# 临时修改（重启失效，先测试）
sudo ip link set dev eth0 mtu 1380
```
> [!info] 辨别
> 在控制台中输入这条命令来获取**上网出口**：
> ```bash
> ip route show default
> ```
> 输出：`default via 159.x.x.1 dev eth0 proto static`
> **关键词**：`dev eth0`
> **结论**：系统明确告诉你，默认的上网出口是 **eth0**
- **客户端不改 (Incoming)**：你的手机/电脑并不知道服务器改了。它们握手时，手机还是会喊：“嘿，我能收 1500 的包！”服务器虽然自己发小的，但如果中间路由器（比如 Azure 的网关）或者 TLS 握手阶段出现了巨型包，依然可能被丢弃。
```bash
sudo iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1340
sudo iptables -t mangle -A OUTPUT -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1340
```
> [!info] 如果显示`iptables not command`
> 

- **客户端修改（Coming）**：
	- 只需要在节点管理的软件中找个这个节点
	- 将`Jitter`或者`TCP Max Transmission Unit(MTU)`
	- 改为和服务器一致或者是比服务器略小的

> **预期效果**：晚高峰的丢包率会下降，视频加载会变快。


### 优化 Linux 内核参数 (Sysctl) —— **缓解 Bufferbloat**
> 现在的 BBR 只是解决了拥塞控制，但我们需要优化 TCP 的缓冲区，让它能“吞”下更多数据，同时防止“吃太饱”导致延迟爆炸。

- **打开 sysctl 配置文件**：
    ```Bash
    nano /etc/sysctl.conf
    ```
- **追加或修改以下参数**（这是针对高 BDP 国际链路的优化版）：
    ```Properties
    # 增加 TCP 缓冲区大小，应对高延迟
    net.core.rmem_max = 16777216
    net.core.wmem_max = 16777216
    net.ipv4.tcp_rmem = 4096 87380 16777216
    net.ipv4.tcp_wmem = 4096 65536 16777216
    
    # 开启 TCP Fast Open (TFO) 减少握手延迟
    net.ipv4.tcp_fastopen = 3
    
    # 优化队列调度算法 (配合 BBR)
    # 这里的 fq 比默认的 fq_codel 对 BBR 更友好
    net.core.default_qdisc = fq
    net.ipv4.tcp_congestion_control = bbr
    
    # 减少超时等待，快速释放连接
    net.ipv4.tcp_fin_timeout = 30
    net.ipv4.tcp_keepalive_time = 1200
    ```
- **生效配置**：
    ```Bash
    sysctl -p
    ```
    
> **预期效果**：图1 中的 Loaded Latency (694ms) 应该会显著下降，意味着你在满速下载时，网页浏览不会卡死。

### 更换端口 (Port Hopping)

- **原理**：DO 的 IP 没被封，但运营商可能会对常见的 `443` 或 `2053` 端口进行限速（QoS）。
- **操作**：
    - 在 3X-UI 面板里，把节点的端口改成一个**极其冷门的高位端口**，比如 **`38245`**、**`51204`**。
    - 记得去防火墙（UFW）放行新端口。
    - **玄学**：有时候换个端口，速度能翻倍。

### 客户端开启 Mux (多路复用) —— **双刃剑测试**

- **原理**：VLESS 协议默认是一条连接传一个请求。开启 Mux 后，就像把多条小溪汇聚成一条大河，在一条 TCP 连接里并发传输数据，能显著欺骗 ISP 的 QoS 策略。
- **操作**：
    - 在小火箭/v2rayN 的节点设置里，找到 **Mux (多路复用)**。
    - **开启它**，并将并发数设为 **8**。
- **注意**：这招在某些地区（如广东移动）会有奇效，但也可能导致断流。**建议作为“大招”测试，如果开了反而卡，就关掉。**
> [!tip] 原理提醒
> **什么是 Mux (多路复用)？**
> 它的原理是把多个逻辑请求（比如 HTTP 请求）塞进**一条** TCP 连接里传输。
> - **优点**：减少 TCP 握手延迟（0-RTT），并发看起来很猛。
> - **缺点**：**队头阻塞 (Head-of-Line Blocking)**。
>
> **为什么你的环境不能开**
> 假设你开启了 Mux（并发数 8）：
> - 你的一条 TCP 连接里跑着 8 个数据流（视频、网页、图片等）。    
> - **晚高峰时**：你的线路丢了一个包（Packet Loss）。
> - **灾难发生**：TCP 协议为了保证顺序，必须等待那个丢失的包重传成功。
> - **后果**：虽然只丢了一个包，但**在这个 TCP 管道里的其他 7 个完全正常的数据流，全部被迫暂停等待**！
> - **体感**：你会觉得看视频“一卡一卡的”，或者网页加载到一半突然卡住不动，比不开 Mux 还要慢。
> 
> **什么时候可以开？**
> 只有在**专线**（IPLC）或者**极低丢包率**（< 0.1%）的网络环境下，Mux 才能发挥由于减少握手带来的加速优势。

---

## 无法SSH连接

### DO服务器
- 先去DO里面打开服务器找到`Recovery`，选用`ISO`启动，重启服务器
- 进入`Access`中启动`Recovery Console`
- 进去之后先挂载硬盘（输入`1`）
> [!warning] 注意
> 是有挂载失败的可能的，挂载失败就尝试手动挂载
> `mount /dev/vdal /mnt`
- 挂载成功之后，进入`chroot`（数字`5`）
- 检查：
	- 防火墙 - `ufw status`
	- SSH脚本 - `/etc/ssh/sshd_config`
> [!error] 严重注意事项：
> 修改完之后记得用`sshd -t`来检测一下有没有语法错误
> 如果弹了`Missing privilege separation directory:/run/sshd`
> 就是说明没有运行的临时环境，用`mkdir -p /run/sshd`再次尝试
> 若是没有任何输出则没有问题
> 记得防火墙要放行对应窗口 - `ufw allow [ssh端口]/tcp` + `ufw reload`

---