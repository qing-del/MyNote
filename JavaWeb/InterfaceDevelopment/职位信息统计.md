# 职位信息统计
## 目录
- [Echarts](#echarts)
- [请求信息](#请求信息)
- [实体类准备](#实体类准备)
- [SQL语句编写](#sql-语句编写)
- [逻辑实现](#逻辑实现)

---

### Echarts
* **Echarts** 是一个**可视化**的**JavaScript**图表库，**基于**的**Vue**框架

---

### 请求信息
* **基本信息**
    * 请求路径：`/report/empJobData`
    * 请求方式：`GET`
* **请求参数**
    * 无
* **响应数据**
    * 参数格式：`application/json`
    * 响应数据样例：

    <details>
    <summary>响应数据样例</summary>

    ```json
    {
        "code": 1,
        "msg": "操作成功",
        "data": {
            "jobData": ["教研主管", "学工主管", "其他", "班主任", "咨询师", "讲师"],
            "dataList": [1,1,2,6,8,13]
        }
    }
    ```
    
    </details>

    * 参数说明：

| 参数名 | 类型 | 是否必须 | 备注 |
| --- | --- | --- | --- |
| code | number | 必须 | 响应码，1 代表成功，0 代表失败 |
| msg | string | 非必须 | 提示信息 |
| data | object | 非必须 | 返回的数据 |
| \|- jobList | string[] | 必须 | 职位列表 |
| \|- dataList | number[] | 必须 | 人数列表 |

---


### 实体类准备
* 需要创建一个实体类，用于封装返回的数据
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class JobOption {
    private List jobList;   //职位列表
    private List dataList;  //人数列表
}
```

---

### SQL 语句编写
* 统计每一种职位对应的人数
```sql
select job, count(*) from emp e group by job;
```

* 使用 case 函数
```sql
-- 用第二种形式编写 （通用性更高）
select 
    case 
        when job = 1 then '班主任'
        when job = 2 then '讲师'
        when job = 3 then '学工主管'
        when job = 4 then '教研主管'
        when job = 5 then '咨询师'
        else '其他' end
    as pos,
    count(*) as num
from emp group by job order by num desc;
```

---

### 逻辑实现
* **Controller 层**

    <details>
    <summary>代码</summary>

    ```java
    @Slf4j
    @RestController
    @RequestMapping("/report")
    public class ReportController { 
        @Autowired
        private ReportService reportService;

        /**
         * 统计员工职位人数
         */
        @GetMapping("/empJobData")
        public Result getEmpJobData() {
            log.info("统计员工职位人数");
            JobOption jobOption = reportService.getEmpJobData();
            return Result.success(jobOption);
        }
    }
    ```

    </details>

<br>

* **Service 层**

    <details>
    <summary>代码</summary>

    ```java
    public interface ReportService { 
        JobOption getEmpJobData();
    }
    ```

    ```java
    @Service
    public class ReportServiceImpl implements ReportService { 
        @Autowired
        private EmpMapper empMapper;

        public JobOption getEmpJobData() { 
            //1. 调用 Mapper 接口获取统计数据
            List<Map<String, Object>> list = empMapper.getEmpJobData();

            //2. 组装结果并返回
            List<Object> jobList = list.stream().map(dateMap -> dateMap.get("pos")).tolist();
            List<Object> dataList = list.stream().map(dateMap -> dateMap.get("num")).tolist();

            return new JobOption(jobList, dataList);
        }
    }
    ```

    </details>

<br>

* **Mapper 层**

    <details>
    <summary>代码</summary>

    ```java
    public interface EmpMapper {
        /**
         * 统计员工职位人数
         * XML 映射文件
         */
        @MapKey("pos")  // 若是报错，则加入这个注解
        List<Map<String, Object>> countEmpJobData();
    }
    ```

    > 这里使用 List 嵌套 Map 的方式，是因为 MyBatis 封装结果是按照如下方式来封装的
    > key: pos  value: 班主任
    > key: num  value: 5
    > 会将 MySQL 查询表中的名称作为 key 值，将查询结果中的数量作为 value 值

    ```xml
    <mapper namespace="com.example.mapper.EmpMapper">
        <select id="countEmpJobData" resultType="java.util.Map">
            case 
                when job = 1 then '班主任'
                when job = 2 then '讲师'
                when job = 3 then '学工主管'
                when job = 4 then '教研主管'
                when job = 5 then '咨询师'
                else '其他' end
            as pos,
            count(*) as num
            from emp e group by pos order by num desc;
        </select>
    </mapper>
    ```

    </details>
