# 修改员工

### 请求方式
1. 基本信息
    * 请求路径：`/emps`
    * 请求方式：`PUT`
2. 请求参数
    * 参数格式：`application/json`
    * 请求数据样例：

    <details>
    <summary>请求数据样例</summary>

    ```json
    {
        "code": 1,
        "message": "success",
        "data": {
            "id": 2,
            "username": "zhangwuji",
            "name": "张无忌",
            "gender": 1,
            "image": "https://example.com/image.jpg",
            "job": 2,
            "salary": 8000,
            "entryDate": "2015-01-01",
            "deptId": 2,
            "createDate": "2022-09-01T23:06:30",
            "updateDate": "2022-09-02T00:29:04",
            "exprList": [
                {
                    "id": 1,
                    "begin": "2012-07-01",
                    "end": "2019-03-03",
                    "company": "百度科技股份有限公司",
                    "job": "Java开发",
                    "empId": 2
                },
                {
                    "id": 2,
                    "begin": "2019-03-15",
                    "end": "2023-03-01",
                    "company": "阿里巴巴科技股份有限公司",
                    "job": "架构师",
                    "empId": 2
                }
            ]
        }
    }
    ```
    
    </details>


    * 参数说明：

| 名称 | 类型 | 是否必须 | 备注 |
|------|------|----------|------|
| id | number | 必须 | 员工的id |
| username | string | 必须 | 用户名 |
| name | string | 必须 | 姓名 |
| gender | number | 必须 | 性别 |
| image | string | 非必须 | 头像 |
| deptId | number | 非必须 | 部门ID |
| entryDate | string | 非必须 | 入职时间 |
| job | number | 非必须 | 职位， 说明：1-班主任，2-讲师，3-学工主管，4-教研主管，5-咨询师 |
| salary | number | 非必须 | 薪资 |
| exprList | array | 非必须 | 工作经历列表 |
| \|- id | number | 非必须 | 工作经历ID |
| \|- company | string | 非必须 | 所在公司名称 |
| \|- job | string | 非必须 | 职位 |
| \|- begin | string | 非必须 | 开始时间 |
| \|- end | string | 非必须 | 结束时间 |
| \|- empId | number | 非必须 | 员工ID |


### SQL 语句编写
* 更新员工基本信息
```sql
update emp set username = "username", name = "name", gender = 0, image = "image",  deptId = 0, "entryDate" = "entryDate", job = 0, salary = 0 where id = 0;
```
* 更新员工工作经历信息
```sql
-- 先删除
delete from emp_expr where emp_id = 0;

-- 再插入
insert into emp_expr(company, job, begin, end, empId) values("company", "job", "begin", "end", 0);
```


### 逻辑实现
* **Controller 层**

    <details> 
    <summary>查看代码</summary>

    ```java
    @Slf4j
    @RestController
    @RequestMapping("/emps")
    public class EmpController { 
        @Autowired
        private EmpService empService;

        @PutMapping
        public Result update(@RequestBody Emp emp) { 
            log.info("修改员工信息：{}", emp);
            empService.update(emp);
            return Result.success();
        }
    }
    ```

    </details>

<br>

* **Service 层**

    <details> 
    <summary>查看代码</summary>

    ```java
    public interface EmpService { 
        public void update(Emp emp);
    }
    ```

    ```java
    @Service
    public class EmpServiceImpl implements EmpService { 
        @Autowired
        private EmpMapper empMapper;
        @Autowired
        private EmpExprMapper empExprMapper;

        @Transactional(rollbackFor = Exception.class)
        @Override
        public void update(Emp emp) { 
            //1. 根据 ID 修改员工的基本信息
            emp.setUpdateTime(LocalDateTime.now());
            empMapper.updateById(emp);

            //2. 根据 ID 修改员工工作经历信息
            //2.1 先根据员工 ID 删除原有的工作经历
            empExprMapper.deleteByEmpIds(Arrays.asList(emp.getId()));

            //2.2 再添加这个员工新的工作经历信息
            List<EmpExpr> empExprs = emp.getEmpExprs();
            if(!empExprs.isEmpty()) {
                empExprs.forEach(empExpr -> empExpr.setEmpId(emp.getId()));
                empExprMapper.insertBatch(empExprs);
            }
        }
    }
    ```

    </details>

<br>

* **Mapper 层**

    <details>
    <summary>查看代码</summary>

    ```java
    @Mapper
    public interface EmpMapper { 
        @Update("update emp set username = #{username}, password = #{password}, name = #{name}, gender = #{gender}, image = #{image}, dept_id = #{deptId}, entry_date = #{entryDate}, update_time = #{updateTime} where id = #{id}")
        void updateById(Emp emp);
    }
    ```

    </details>


### 程序优化
* 若是我们根据`id`更新员工的基本信息的时候，仅需要根据`id`跟新员工的`username`，那么传递的属性就只有`id` `username` `updateTime`三个属性值，而编写的 SQL 语句中，所有的属性都会被更新，而没有传递进来的值将会被赋值为 null，所以我们需要提升 Mapper 接口的灵活性和扩展性
> 解析来是我们将 Mapper 接口改成 XML 映射文件的方式

```xml
<mapper namespace="com.example.mapper.EmpMapper">
    <update id="updateById">
        update emp
        <set>
            <if test="username != null and username != ''">username = #{username},</if>
            <if test="password != null and password != ''">password = #{password},</if>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="gender != null">gender = #{gender},</if>
            <if test="phone != null and phone != ''">phone = #{phone},</if>
            <if test="job != null">job = #{job},</if>
            <if test="salary != null">salary = #{salary},</if>
            <if test="image != null and image != ''">image = #{image},</if>
            <if test="entryDate != null">entry_date = #{entryDate},</if>
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
    where id = #{id}
    </update>
</mapper>
```
> set 标签：会自动生成set关键字，会自动删除更新字多后多余','